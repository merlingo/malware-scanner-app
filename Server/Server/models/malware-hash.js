var mongoose = require('mongoose');
var Schema = mongoose.Schema;
const fs = require('fs');
var config = require('../config');

// sistemde kayitli müsteriler icin  model - Mongoose model for clients registered in the system
var malhashSchema = new Schema({
    hash: {
        type: String,
        required: true
    },
    name: {
        type: String
    },
    extension: {
        type: String
    },
    virustotal: {//in the range of  [0,1]. This is the point of how many virustotal antiviruses detect it as malware.
        type: Number 
    },
    isChecked: {
        type: Boolean,
        default: false
    }
}, {
        timestamps: true
    });

//add new function pre save which update file
malhashSchema.pre('save', function (next) {
    var malhash = this;
    sep = "\n";
    save(malhash.hash, sep, function (err) {
        if (err) {
            console.log(err);
            next(err);
        }
        next();
    });
    /*
    if (!user.isModified('password')) return next();
    hashedPass = bcrypt.hash(user.password, null, null, function (err, hash) {
        if (err) return next(err);
        user.password = hash;
        next();
    });
    */
});

function save(h, sep, f) {
    filename = config.malhash_filename;
    //save h into hash file
    data = h + sep;
    fs.appendFile(filename, data, (err) => {
        // In case of a error throw err. 
        f(err);

    });
}
var malhash = mongoose.model('malwarehash', malhashSchema);

// make this available to our Node applications
module.exports = malhash;
